<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">



<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.3/css/all.min.css" integrity="sha256-2H3fkXt6FEmrReK448mDVGKb3WW2ZZw35gI7vqHOE4Y=" crossorigin="anonymous">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/animate.css@3.1.1/animate.min.css" integrity="sha256-PR7ttpcvz8qrF57fur/yAx1qXMFJeJFiA6pSzWi0OIE=" crossorigin="anonymous">

<script class="next-config" data-name="main" type="application/json">{&quot;hostname&quot;:&quot;example.com&quot;,&quot;root&quot;:&quot;&#x2F;&quot;,&quot;images&quot;:&quot;&#x2F;images&quot;,&quot;scheme&quot;:&quot;Gemini&quot;,&quot;version&quot;:&quot;8.4.0&quot;,&quot;exturl&quot;:false,&quot;sidebar&quot;:{&quot;position&quot;:&quot;left&quot;,&quot;display&quot;:&quot;always&quot;,&quot;padding&quot;:18,&quot;offset&quot;:12},&quot;copycode&quot;:false,&quot;bookmark&quot;:{&quot;enable&quot;:false,&quot;color&quot;:&quot;#222&quot;,&quot;save&quot;:&quot;auto&quot;},&quot;fancybox&quot;:false,&quot;mediumzoom&quot;:false,&quot;lazyload&quot;:false,&quot;pangu&quot;:false,&quot;comments&quot;:{&quot;style&quot;:&quot;tabs&quot;,&quot;active&quot;:null,&quot;storage&quot;:true,&quot;lazyload&quot;:false,&quot;nav&quot;:null},&quot;motion&quot;:{&quot;enable&quot;:true,&quot;async&quot;:false,&quot;transition&quot;:{&quot;post_block&quot;:&quot;fadeIn&quot;,&quot;post_header&quot;:&quot;fadeInDown&quot;,&quot;post_body&quot;:&quot;fadeInDown&quot;,&quot;coll_header&quot;:&quot;fadeInLeft&quot;,&quot;sidebar&quot;:&quot;fadeInUp&quot;}},&quot;prism&quot;:false,&quot;i18n&quot;:{&quot;placeholder&quot;:&quot;Searching...&quot;,&quot;empty&quot;:&quot;We didn&#39;t find any results for the search: ${query}&quot;,&quot;hits_time&quot;:&quot;${hits} results found in ${time} ms&quot;,&quot;hits&quot;:&quot;${hits} results found&quot;}}</script>
<meta name="description" content="说点骚话:转换需要用到 Windows API (废话) 官方文档: GetShortPathNameW function (fineapi.h) - Win32 apps | Microsoft docs  (纯英文, 没有中文版本.) 引用命名空间:1using System.Runtime.InteropServices; 关键代码: C#12345678910111213141516171">
<meta property="og:type" content="article">
<meta property="og:title" content="[C#&#x2F;C&#x2F;C++] GetShortPathName详解, 长路径转换为短路径">
<meta property="og:url" content="http://example.com/2021/05/11/202102090805/index.html">
<meta property="og:site_name" content="SlimeNull&#39;s Blog">
<meta property="og:description" content="说点骚话:转换需要用到 Windows API (废话) 官方文档: GetShortPathNameW function (fineapi.h) - Win32 apps | Microsoft docs  (纯英文, 没有中文版本.) 引用命名空间:1using System.Runtime.InteropServices; 关键代码: C#12345678910111213141516171">
<meta property="og:locale" content="en_US">
<meta property="article:published_time" content="2021-05-11T02:54:31.386Z">
<meta property="article:modified_time" content="2021-05-11T03:46:00.936Z">
<meta property="article:author" content="SlimeNull">
<meta name="twitter:card" content="summary">


<link rel="canonical" href="http://example.com/2021/05/11/202102090805/">



<script class="next-config" data-name="page" type="application/json">{&quot;sidebar&quot;:&quot;&quot;,&quot;isHome&quot;:false,&quot;isPost&quot;:true,&quot;lang&quot;:&quot;en&quot;,&quot;comments&quot;:true,&quot;permalink&quot;:&quot;http:&#x2F;&#x2F;example.com&#x2F;2021&#x2F;05&#x2F;11&#x2F;202102090805&#x2F;&quot;,&quot;path&quot;:&quot;2021&#x2F;05&#x2F;11&#x2F;202102090805&#x2F;&quot;,&quot;title&quot;:&quot;[C#&#x2F;C&#x2F;C++] GetShortPathName详解, 长路径转换为短路径&quot;}</script>

<script class="next-config" data-name="calendar" type="application/json">&quot;&quot;</script>
<title>[C#/C/C++] GetShortPathName详解, 长路径转换为短路径 | SlimeNull's Blog</title><script src="/js/config.js"></script>
  




  <noscript>
    <link rel="stylesheet" href="/css/noscript.css">
  </noscript>
</head>

<body itemscope itemtype="http://schema.org/WebPage" class="use-motion">
  <div class="headband"></div>

  <main class="main">
    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar" role="button">
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
        <span class="toggle-line"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <i class="logo-line"></i>
      <h1 class="site-title">SlimeNull's Blog</h1>
      <i class="logo-line"></i>
    </a>
      <p class="site-subtitle" itemprop="description">For the better opensource world!</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>



<nav class="site-nav">
  <ul class="main-menu menu">
        <li class="menu-item menu-item-home"><a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a></li>
        <li class="menu-item menu-item-about"><a href="/about/" rel="section"><i class="fa fa-user fa-fw"></i>About</a></li>
        <li class="menu-item menu-item-tags"><a href="/tags/" rel="section"><i class="fa fa-tags fa-fw"></i>Tags</a></li>
        <li class="menu-item menu-item-categories"><a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>Categories</a></li>
        <li class="menu-item menu-item-archives"><a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a></li>
        <li class="menu-item menu-item-sitemap"><a href="/sitemap.xml" rel="section"><i class="fa fa-sitemap fa-fw"></i>Sitemap</a></li>
  </ul>
</nav>




</div>
        
  
  <div class="toggle sidebar-toggle" role="button">
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
    <span class="toggle-line"></span>
  </div>

  <aside class="sidebar">

    <div class="sidebar-inner sidebar-nav-active sidebar-toc-active">
      <ul class="sidebar-nav">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <div class="sidebar-panel-container">
        <!--noindex-->
        <div class="post-toc-wrap sidebar-panel">
            <div class="post-toc animated"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E8%AF%B4%E7%82%B9%E9%AA%9A%E8%AF%9D"><span class="nav-number">1.</span> <span class="nav-text">说点骚话:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%BC%95%E7%94%A8%E5%91%BD%E5%90%8D%E7%A9%BA%E9%97%B4"><span class="nav-number">2.</span> <span class="nav-text">引用命名空间:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%85%B3%E9%94%AE%E4%BB%A3%E7%A0%81"><span class="nav-number">3.</span> <span class="nav-text">关键代码:</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%9B%B4%E5%A4%9A%E8%AF%B4%E6%98%8E"><span class="nav-number">4.</span> <span class="nav-text">更多说明:</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AE%B9-1"><span class="nav-number">4.0.1.</span> <span class="nav-text">内容 1:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AE%B9-2"><span class="nav-number">4.0.2.</span> <span class="nav-text">内容 2:</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E5%86%85%E5%AE%B9-3"><span class="nav-number">4.0.3.</span> <span class="nav-text">内容 3:</span></a></li></ol></li></ol></li></ol></div>
        </div>
        <!--/noindex-->

        <div class="site-overview-wrap sidebar-panel">
          <div class="site-author site-overview-item animated" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">SlimeNull</p>
  <div class="site-description" itemprop="description">Newbie... Learning...</div>
</div>
<div class="site-state-wrap site-overview-item animated">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">70</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">2</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>
  <div class="links-of-author site-overview-item animated">
      <span class="links-of-author-item">
        <a href="https://github.com/slimenull" title="GitHub → https:&#x2F;&#x2F;github.com&#x2F;slimenull" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:slimenull@outlook.com" title="E-Mail → mailto:slimenull@outlook.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://space.bilibili.com/441842015" title="Bilibili → https:&#x2F;&#x2F;space.bilibili.com&#x2F;441842015" rel="noopener" target="_blank">Bilibili</a>
      </span>
  </div>



        </div>
      </div>
    </div>
  </aside>
  <div class="sidebar-dimmer"></div>


    </header>

    
  <div class="back-to-top" role="button" aria-label="Back to top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>

<noscript>
  <div class="noscript-warning">Theme NexT works best with JavaScript enabled</div>
</noscript>


    <div class="main-inner post posts-expand">


  


<div class="post-block">
  
  

  <article itemscope itemtype="http://schema.org/Article" class="post-content" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/05/11/202102090805/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="SlimeNull">
      <meta itemprop="description" content="Newbie... Learning...">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="SlimeNull's Blog">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          [C#/C/C++] GetShortPathName详解, 长路径转换为短路径
        </h1>

        <div class="post-meta-container">
          <div class="post-meta">
    <span class="post-meta-item">
      <span class="post-meta-item-icon">
        <i class="far fa-calendar"></i>
      </span>
      <span class="post-meta-item-text">Posted on</span>
      

      <time title="Created: 2021-05-11 10:54:31 / Modified: 11:46:00" itemprop="dateCreated datePublished" datetime="2021-05-11T10:54:31+08:00">2021-05-11</time>
    </span>

  
</div>

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">
        <h2 id="说点骚话"><a href="#说点骚话" class="headerlink" title="说点骚话:"></a>说点骚话:</h2><p>转换需要用到 Windows API (废话)</p>
<p>官方文档: <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-getshortpathnamew">GetShortPathNameW function (fineapi.h) - Win32 apps | Microsoft docs</a>  (纯英文, 没有中文版本.)</p>
<h2 id="引用命名空间"><a href="#引用命名空间" class="headerlink" title="引用命名空间:"></a>引用命名空间:</h2><figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">using</span> System.Runtime.InteropServices;</span><br></pre></td></tr></table></figure>
<h2 id="关键代码"><a href="#关键代码" class="headerlink" title="关键代码:"></a>关键代码:</h2><ul>
<li>C#<figure class="highlight csharp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[<span class="meta">DllImport(<span class="meta-string">&quot;kernel32.dll&quot;</span>, EntryPoint = <span class="meta-string">&quot;GetShortPathNameW&quot;</span>, CharSet = CharSet.Unicode)</span>]</span><br><span class="line"><span class="function"><span class="keyword">extern</span> <span class="keyword">static</span> <span class="built_in">short</span> <span class="title">GetShortPath</span>(<span class="params"><span class="built_in">string</span> longPath, <span class="built_in">string</span> buffer, <span class="built_in">int</span> bufferSize</span>)</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取转换所需要的缓冲区大小</span></span><br><span class="line"><span class="function"><span class="built_in">bool</span> <span class="title">TryGetConvertBufferSize</span>(<span class="params"><span class="built_in">string</span> longPath, <span class="keyword">out</span> <span class="built_in">short</span> size</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    size = GetShortPath(longPath, <span class="literal">null</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">return</span> size != <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 进行转换</span></span><br><span class="line"><span class="function"><span class="built_in">bool</span> <span class="title">TryGetShortPath</span>(<span class="params"><span class="built_in">string</span> longPath, <span class="keyword">out</span> <span class="built_in">string</span> shortPath, <span class="built_in">int</span> bufferSize = <span class="number">256</span></span>)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">string</span> resultBuffer = <span class="keyword">new</span> <span class="built_in">string</span>(<span class="string">&#x27;\0&#x27;</span>, bufferSize);               <span class="comment">// 256 大概合适, 根据需求调整吧</span></span><br><span class="line">    <span class="built_in">short</span> rstLen = GetShortPath(longPath, resultBuffer, bufferSize);</span><br><span class="line">    <span class="keyword">if</span> (rstLen != <span class="number">0</span> &amp;&amp; rstLen != bufferSize)</span><br><span class="line">    &#123;</span><br><span class="line">        shortPath = resultBuffer.TrimEnd(<span class="string">&#x27;\0&#x27;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line">    &#123;</span><br><span class="line">        shortPath = <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
<li>C++<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">    <span class="keyword">long</span>     length = <span class="number">0</span>;</span><br><span class="line">    TCHAR*   buffer = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 初次通过传递NULL和0来获取所需空间</span></span><br><span class="line"></span><br><span class="line">    length = GetShortPathName(lpszPath, <span class="literal">NULL</span>, <span class="number">0</span>);</span><br><span class="line">    <span class="keyword">if</span> (length == <span class="number">0</span>) ErrorExit(TEXT(<span class="string">&quot;GetShortPathName&quot;</span>));</span><br><span class="line"></span><br><span class="line"><span class="comment">// 动态分配准确的内存</span></span><br><span class="line"></span><br><span class="line">    buffer = <span class="keyword">new</span> TCHAR[length];</span><br><span class="line"></span><br><span class="line"><span class="comment">// 现在, 使用同一个长路径来简单调用函数吧</span></span><br><span class="line"></span><br><span class="line">    length = GetShortPathName(lpszPath, buffer, length);</span><br><span class="line">    <span class="keyword">if</span> (length == <span class="number">0</span>) ErrorExit(TEXT(<span class="string">&quot;GetShortPathName&quot;</span>));</span><br><span class="line"></span><br><span class="line">    _tprintf(TEXT(<span class="string">&quot;long name = %s shortname = %s&quot;</span>), lpszPath, buffer);</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">delete</span> [] buffer;</span><br></pre></td></tr></table></figure>
<h2 id="更多说明"><a href="#更多说明" class="headerlink" title="更多说明:"></a>更多说明:</h2><h4 id="内容-1"><a href="#内容-1" class="headerlink" title="内容 1:"></a>内容 1:</h4>如果设置了 buffer, 与 bufferSize, 函数会尝试转换长路径到短路径, 如果返回的数字与 bufferSize 一致, 则表示缓冲区(buffer)太小.</li>
</ul>
<p>如果 buffer 被设为 null, bufferSize 被设为 0, 则返回值将返回所需要的缓冲区大小.</p>
<p>无论如何, 如果返回值是 0, 则表示函数由于某些原因, 未能成功执行.</p>
<p>获取更多的错误信息, 请调用 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror">CallLastError</a></p>
<p><strong>原文:</strong></p>
<blockquote>
<p>If the function succeeds, the return value is the length, in TCHARs, of the string that is copied to lpszShortPath, not including the terminating null character.<br>&nbsp;<br>If the lpszShortPath buffer is too small to contain the path, the return value is the size of the buffer, in TCHARs, that is required to hold the path and the terminating null character.<br>&nbsp;<br>If the function fails for any other reason, the return value is zero. To get extended error information, call <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/api/errhandlingapi/nf-errhandlingapi-getlasterror">GetLastError</a>.</p>
</blockquote>
<h4 id="内容-2"><a href="#内容-2" class="headerlink" title="内容 2:"></a>内容 2:</h4><p>在这个函数(GetShortPathName)的 ANSI 版本中, 路径长度被限制在 MAX_PATH(260) 个字符. 要拓展这个限制到 23767 宽字符(wide character), 请调用这个函数的 Unicode 版本, 并且在路径的首部加上 “\\?\“. 更多信息, 请查阅 <a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/desktop/FileIO/naming-a-file">文件, 路径, 以及命名空间的命名</a><br><strong>原文:</strong></p>
<blockquote>
<p>In the ANSI version of this function, the name is limited to MAX_PATH characters. To extend this limit to 32,767 wide characters, call the Unicode version of the function and prepend “\?&quot; to the path. For more information, see Naming Files, Paths, and Namespaces.</p>
</blockquote>
<h4 id="内容-3"><a href="#内容-3" class="headerlink" title="内容 3:"></a>内容 3:</h4><p>关于 Windows API 函数的 Unicode 版本和 ANSI 版本的区别, 可参阅: <a target="_blank" rel="noopener" href="https://blog.csdn.net/m0_46555380/article/details/109834245">Windows API 函数后缀的作用</a></p>

    </div>

    
    
    

    <footer class="post-footer">

        

          <div class="post-nav">
            <div class="post-nav-item">
                <a href="/2021/05/11/202102111042/" rel="prev" title="[C#] 音乐播放 3 种方式 Demo 与 MCI 音乐播放器封装类.">
                  <i class="fa fa-chevron-left"></i> [C#] 音乐播放 3 种方式 Demo 与 MCI 音乐播放器封装类.
                </a>
            </div>
            <div class="post-nav-item">
                <a href="/2021/05/11/202102090304/" rel="next" title="[C#] WinForm 与 WPF 获取命令行参数">
                  [C#] WinForm 与 WPF 获取命令行参数 <i class="fa fa-chevron-right"></i>
                </a>
            </div>
          </div>
    </footer>
  </article>
</div>





<script src="/js/comments.js"></script>
</div>
  </main>

  <footer class="footer">
    <div class="footer-inner">


<div class="copyright">
  &copy; 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">SlimeNull</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.js.org/" rel="noopener" target="_blank">NexT.Gemini</a>
  </div>

    </div>
  </footer>

  
  <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js" integrity="sha256-XL2inqUJaslATFnHdJOi9GfQ60on8Wx1C2H8DYiN1xY=" crossorigin="anonymous"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script><script src="/js/next-boot.js"></script>

  






  





</body>
</html>
